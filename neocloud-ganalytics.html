<!--
@license
Copyright (c) 2017 Neo
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-localstorage/iron-localstorage.html">

<dom-module id="neocloud-ganalytics">
  <template>
    <iron-localstorage name="app-config" value="{{appconfig}}" on-iron-localstorage-load="_setGoogleAnalytics"></iron-localstorage>
  </template>

  <script>
    (function (i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function () {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

    Polymer({
      is: 'neocloud-ganalytics',

      properties: {
        /**
         * appconfig value
         */
        appconfig: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },
        lastPage: {
          type: String,
          value: ""
        },
        gaCreated: {
          type: Boolean,
          value: false
        }
      },

      ready: function(){
      },

      /**
       *
       * @private
       * Set google analytics with the value saved in local-storage
       */
      _setGoogleAnalytics: function(){
        if (this.appconfig.analytics !== "") {
          ga('create', this.appconfig.analytics, 'auto');
          this.gaCreated = true;
          ga('set', 'page', location.pathname);
          ga('send', 'pageview');
        }
      },

      updateGoogleAnalytics: function(){
        if (!this.gaCreated) return;
        if (location.pathname != this.lastPage) {
          this.lastPage = location.pathname;
          ga('set', 'page', this.lastPage);
          ga('send', 'pageview');
        }
      }

    });


  </script>
</dom-module>
